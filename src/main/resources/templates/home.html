<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>TODO</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
        <script
            src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

        <style>
            body {
                background: #F9F9F9;
            }
        </style>

    </head>
    <body>


        <!--NAVIGATION BAR-->
        <div class="ui attached stackable inverted menu">
            <div class="ui container">
                <a class="item" href="/">Explore</a>
                <a class="item" href="#" onclick="popupUpload()" sec:authorize="isAuthenticated()">Upload</a>
                <a class="item" href="#" onclick="popupEditProfile()" sec:authorize="isAuthenticated()">Edit Profile</a>
                <a class="item" href="/logged-in/logout" sec:authorize="isAuthenticated()">Logout</a>
                <a class="item" href="/login" sec:authorize="!isAuthenticated()">Login</a>
                <a class="item" href="/register" sec:authorize="!isAuthenticated()">Register</a>
                <div class="right item">
                    <div class="ui transparent left icon inverted input">
                        <input type="text" placeholder="Search...">
                        <i class="search icon"></i>
                    </div>
                </div> 
            </div>
        </div>

        <!--MESSAGES-->
        <div class="ui container">
            <div th:if="${showUploadSuccess}">
                <div class="ui hidden divider"></div>
                <div class="ui success large message" id="message-container">
                    <i class="close icon" onclick="document.getElementById('message-container').style = 'display: none'"></i>
                    <div class="header">
                        Your upload was successful.
                    </div>
                </div>
            </div>
            <div th:if="${showDeleteSuccess}">
                <div class="ui hidden divider"></div>
                <div class="ui success large message" id="message-container">
                    <i class="close icon" onclick="document.getElementById('message-container').style = 'display: none'"></i>
                    <div class="header">
                        Your photo was successfully deleted.
                    </div>
                </div>
            </div>
            <div th:if="${showEditProfileSuccess}">
                <div class="ui hidden divider"></div>
                <div class="ui success large message" id="message-container">
                    <i class="close icon" onclick="document.getElementById('message-container').style = 'display: none'"></i>
                    <div class="header">
                        Your profile was successfully updated.
                    </div>
                </div>
            </div>
        </div>

        <!--HEADER PROFILE DISPLAY-->
        <div class="ui hidden divider"></div>
        <div class="ui container">
            <div class="ui segment left aligned">
                <div class="ui items">
                    <div class="item">
                        <a class="ui medium image">
                            <div class="ui grey ribbon label large">
                                [[${profile.getName()}]]
                            </div>
                            <img src="https://images.pexels.com/photos/2800724/pexels-photo-2800724.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940">
                        </a>
                        <div class="content center">
                            <div class="description">
                                <p style="white-space: pre-line">[[${profile.getBio()}]]</p>
                            </div>
                            <div class="extra">
                                <div class="ui label"><i class="user icon"></i>[[${user.username()}]]</div>
                                <a href="#" onclick="#" th:attr="onclick=|location.href='${profile.getWebsite()}'; event.preventDefault();|">
                                    <div class="ui label"><i class="globe icon"></i>[[${profile.getWebsite()}]]</div>
                                </a>
                                <div class="ui label"><i class="envelope icon"></i>[[${profile.getEmail()}]]</div>
                                <div class="ui label"><i class="phone icon"></i>[[${profile.getPhone()}]]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--CURRENT USER PHOTO GRID-->
        <div class="ui hidden divider"></div>
        <div class="ui horizontal divider">&nbsp;</div>
        <div class="ui hidden divider"></div>
        <div class="ui container">
            <div class="ui special cards three stackable">
                <div class="card blurring dimmable image" th:each="photo : ${photos}">
                    <div class="ui dimmer">
                        <div class="content">
                            <div class="center">
                                <!--TODO Truncated caption for thumbnails-->
                                <p>[[${photo.caption()}]]</p>
                                <a href="#" onclick="#" th:attr="onclick=|popupImage('${photo.url()}', ${photo.id()}, '${photo.cloud()}', '${photo.caption()}'); event.preventDefault();|">
                                    <div class="ui inverted mini button">View Photo</div>
                                </a>
                            </div>
                        </div>
                    </div>
                    <img class="ui image" src="#" th:src="${photo.thumbnail()}" />
                </div>
            </div>
        </div>


        <!--EDIT PROFILE-->        
        <div class="ui medium modal" id="modal-edit-profile">
            <div class="header">
                Edit Profile
            </div>
            <div class="content">
                <form th:action="@{/logged-in/user/profile/update}" th:object="${profile}" th:method="put" class="ui form" id="form-edit-profile">
                    <div class="fields">
                        <div class="field">
                            <label>Name</label>
                            <input type="text" placeholder="Name" th:field="*{name}" />
                        </div>
                        <div class="field">
                            <label>Website</label>
                            <input type="text" placeholder="Website" th:field="*{website}" />
                        </div>
                        <div class="field">
                            <label>Email</label>
                            <input type="text" placeholder="Email" th:field="*{email}" />
                        </div>
                        <div class="field">
                            <label>Phone</label>
                            <input type="text" placeholder="Phone" th:field="*{phone}" />
                        </div>
                    </div>
                    <div class="field">
                        <label>Artist Bio</label>
                        <textarea placeholder="Bio" th:field="*{bio}" rows="18"></textarea>
                    </div>
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                </form>
            </div>
            <div class="actions">
                <div class="ui black deny button">
                    Cancel
                </div>
                <a href="#" onclick="document.getElementById('form-edit-profile').submit()">
                    <div class="ui positive button">
                        Update
                    </div>
                </a>
            </div>
        </div>

        <!--UPLOAD MODAL-->
        <div class="ui mini modal" id="modal-upload">
            <div class="header">
                Upload
            </div>
            <div class="content">
                <div class="ui active dimmer" id="loader-upload" style="display: none">
                    <div class="ui indeterminate text loader">Uploading</div>
                </div>
                <form th:action="@{/logged-in/photo/upload}" th:object="${photo}" method="post" class="ui form" id="form-upload">
                    <input type="hidden" th:field="*{url}" id="photo-url"/>
                    <div class="field">
                        <label>Photo</label>
                        <input type="file" accept="image/*" onchange="setFiles(this.files)"/>
                    </div>
                    <div class="field">
                        <label>Caption</label>
                        <input type="text" placeholder="Caption" th:field="*{caption}" />
                    </div>
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                </form>
            </div>
            <div class="actions">
                <div class="ui black deny button">
                    Cancel
                </div>
                <a href="#" onclick="handleFileUpload()">
                    <div class="ui green button">
                        Upload
                    </div>
                </a>
            </div>
        </div>

        <!--IMAGE IS CLICKED-->
        <div class="ui basic fullscreen modal" id="modal-image">
            <div class="ui active dimmer" id="loader-delete" style="display: none">
                <div class="ui indeterminate text loader">Deleting</div>
            </div>
            <div class="image content">
                <img class="ui huge image" src="#" id="modal-image-src"> 
                <div class="description">
                    <p id="modal-image-caption"></p>


                    <form th:action="@{/logged-in/photo/delete}" th:method="delete" id="form-photo-delete" style="display: none">
                        <input type="hidden" id="photo-delete-id" name="id" value=""/>
                        <input type="hidden" id="photo-delete-cloud" name="cloud" value=""/>
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    </form>

                    <div class="ui red inverted button icon" 
                         targetId=""
                         targetCloudName=""
                         onclick="deletePhoto(this.targetId, this.targetCloudName)" 
                         id="delete-image-details">
                        <i class="trash alternate icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui hidden divider"></div>
        <div class="ui hidden divider"></div>
        <div class="ui hidden divider"></div>
        <div class="ui inverted vertical footer segment" style="margin-top: 70px; padding-top: 30px; padding-bottom: 30px">
            <div class="ui center aligned container">
                <div class="ui horizontal inverted small divided link list">
                    <a class="item" href="#">Site Map</a>
                    <a class="item" href="#">Contact Us</a>
                    <a class="item" href="#">Terms and Conditions</a>
                    <a class="item" href="#">Privacy Policy</a>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            $('.special.cards .image').dimmer({
                on: 'hover'
            });

            function popupImage(imgSrc, id, cloudName, caption) {
                document.getElementById('modal-image-src').src = imgSrc;
                document.getElementById('modal-image-caption').innerHTML = caption;

                // Delete button.
                document.getElementById('delete-image-details').targetId = id;
                document.getElementById('delete-image-details').targetCloudName = cloudName;

                $('#modal-image').modal('show');
            }

            function popupUpload() {
                $('#modal-upload').modal('show');
            }

            function popupEditProfile() {
                $('#modal-edit-profile').modal('show');
            }

            function deletePhoto(id, cloud) {
                document.getElementById('loader-delete').style = '';

                // Form.
                document.getElementById('photo-delete-id').value = id;
                document.getElementById('photo-delete-cloud').value = cloud;
                document.getElementById('form-photo-delete').submit();
            }
        </script>

        <!--Code for upload functionality-->
        <script type="text/javascript">

            // Upload variables.
            const cloudName = 'hqx5vpvj4';
            const unsignedUploadPreset = 'nihp5svy';

            // Do upload to Cloudinary.
            function uploadFile(file) {
                var url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
                var xhr = new XMLHttpRequest();
                var fd = new FormData();

                xhr.open('POST', url, true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.onreadystatechange = function (e) {
                    if (xhr.readyState === 4 && xhr.status === 200) {

                        // File uploaded successfully
                        var response = JSON.parse(xhr.responseText);
                        var url = response.secure_url;

                        // Create a thumbnail of the uploaded image, with 150px width
                        var tokens = url.split('/');
                        // TODO Optimize photos, enable thumbnails.
                        // tokens.splice(-2, 0, 'w_150,c_scale');

                        var img = new Image();
                        img.src = tokens.join('/');
                        document.getElementById('photo-url').value = img.src;
                        document.getElementById('form-upload').submit();
                    }
                };

                fd.append('upload_preset', unsignedUploadPreset);
                fd.append('public_id', '/[[${user.username()}]]/' + uuidv4());
                fd.append('tags', 'browser_upload');
                fd.append('file', file);
                xhr.send(fd);
            }

            // TODO Handle valid image extensions only.
            // Handle selected files
            var handleFileUpload = function () {
                document.getElementById('loader-upload').style = '';
                for (var i = 0; i < files.length; i++) {
                    uploadFile(files[i]);
                }
            };

            function setFiles(filesToUpload) {
                files = filesToUpload;
            }

            function uuidv4() {
                return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                )
            }
        </script>
    </body>

</html>
